(function(e){var t=acf.media;acf.fields.image={$el:null,$input:null,o:{},set:function(t){e.extend(this,t);this.$input=this.$el.find('input[type="hidden"]');this.o=acf.helpers.get_atts(this.$el);this.o.multiple=this.$el.closest(".repeater").exists()?!0:!1;this.o.query={type:"image"};this.o.library=="uploadedTo"&&(this.o.query.uploadedTo=acf.o.post_id);return this},init:function(){if(acf.helpers.is_clone_field(this.$input))return},add:function(e){var n=t.div;n.find(".acf-image-image").attr("src",e.url);n.find(".acf-image-value").val(e.id).trigger("change");n.addClass("active");n.closest(".field").removeClass("error")},edit:function(){t.div=this.$el;tb_show(acf.l10n.image.edit,acf.o.admin_url+"media.php?attachment_id="+this.$input.val()+"&action=edit&acf_action=edit_attachment&acf_field=image&TB_iframe=1")},remove:function(){this.$el.find(".acf-image-image").attr("src","");this.$el.find(".acf-image-value").val("").trigger("change");this.$el.removeClass("active")},popup:function(){var n=this;t.div=this.$el;if(t.type()=="backbone"){t.clear_frame();t.frame=wp.media({states:[new wp.media.controller.Library({library:wp.media.query(n.o.query),multiple:n.o.multiple,title:acf.l10n.image.select,priority:20,filterable:"all"})]});acf.media.frame.on("content:activate",function(){var t=null,r=null;try{t=acf.media.frame.content.get().toolbar;r=t.get("filters")}catch(i){}if(!r)return!1;e.each(r.filters,function(e,t){t.props.type="image"});if(n.o.library=="uploadedTo"){r.$el.find('option[value="uploaded"]').remove();r.$el.after("<span>"+acf.l10n.image.uploadedTo+"</span>");e.each(r.filters,function(e,t){t.props.uploadedTo=acf.o.post_id})}r.$el.find("option").each(function(){var t=e(this).attr("value");if(t=="uploaded"&&n.o.library=="all")return;t.indexOf("image")===-1&&e(this).remove()});r.$el.val("image").trigger("change")});acf.media.frame.on("select",function(){selection=t.frame.state().get("selection");if(selection){var e=0;selection.each(function(r){e++;if(e>1){var s=t.div.closest("td").attr("data-field_key"),o=t.div.closest("tr"),u=o.closest(".repeater");if(o.next(".row").exists())t.div=o.next(".row").find('td[data-field_key="'+s+'"] .acf-image-uploader');else{u.find(".add-row-end").trigger("click");t.div=u.find('> table > tbody > tr.row:last td[data-field_key="'+s+'"] .acf-image-uploader')}}var a={id:r.id,url:r.attributes.url};r.attributes.sizes&&r.attributes.sizes[n.o.preview_size]&&(a.url=r.attributes.sizes[n.o.preview_size].url);acf.fields.image.add(a)})}});acf.media.frame.open()}else tb_show(acf.l10n.image.select,acf.admin_url+"media-upload.php?post_id="+acf.o.post_id+"&post_ID="+acf.o.post_id+"&type=image&acf_type=image&acf_preview_size="+n.o.preview_size+"&TB_iframe=1");return!1},text:{title_add:"Select Image",title_edit:"Edit Image"}};e(".acf-image-uploader .acf-button-edit").live("click",function(){acf.fields.image.set({$el:e(this).closest(".acf-image-uploader")}).edit();return!1});e(".acf-image-uploader .acf-button-delete").live("click",function(){acf.fields.image.set({$el:e(this).closest(".acf-image-uploader")}).remove();return!1});e(".acf-image-uploader .add-image").live("click",function(){acf.fields.image.set({$el:e(this).closest(".acf-image-uploader")}).popup();return!1})})(jQuery);